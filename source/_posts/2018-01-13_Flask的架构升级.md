---
title: Flask 的架构升级
date: 2018-01-13 00:00:00
tags:
- Python
- Flask
---

> 标题党
+ <!--more-->

## start

- 普通的个人系统一开始都很简单，只是满足单个需求，甚至只需要单个文件就能满足
- 在这个时候，你的程序可能这样的（这个示例程序还需要`templates`文件夹存放模板）

```python
# manage.py
#!/usr/bin/python
# -*- coding:utf-8 -*-
from flask import Flask
app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/hello_world')
def hello_world():
    return 'Hello World!'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=80)
```

使用命令`python manage.py`可以启动服务。这是一种最原始的架设服务的方式，但也是最快的。此时，所有的功能均在单文件完成，由于实现的功能不多，根据不同的路由可以快速找到不同功能对应的代码。随着代码复杂度的增加，大约到单文件一两百行时，这种单文件方式就会显得很吃力。虽然增加新功能一点都不会吃力，但是 debug 的时候你一定会尝到苦头的。而且这样做存在一些问题
  - flask 的自带服务器仅适用于测试，不支持多线程，用于多人的环境时很容易发生阻塞
  - 一旦你的 shell 关闭，你的服务将被停止。你需要一种让进程在后台可靠运行的方法，可以使用`nohup python manage.py &`，或者挂一个 screen 用于服务`screen -S 服务器``python manage.py`(这些方案只适用于快速搭建服务，使用服务器提供服务才是正道)

## 扩展

随着功能的增加，你开始根据不同功能把程序拆分成文件，使用`manage.py`作为入口，在`views.py`处理路由，在`errors.py`中处理错误。项目结构：

```
proj
│  manage.py
│
├─app
│  errors.py
│  utils.py
│  views.py
│  __init__.py
│
├─templates
│  about.html
│  index.html
│  login.html
│
└─static
   app.js
   app.css

```

也可以通过为不同功能新建不同文件夹进一步扩展。在这一阶段，你的架构能够使用非常久。因此，你必须利用这段时间把之前没做的工作补上。

## 查缺补漏

这一部分的内容应该在创建工程的时候就被考虑到并且实施。不过你如果非常非常赶时间，那就只能现在补做了

- 服务器 你需要使用 web 服务器。如 Nginx, Gunicorn, Tornado
- 除了选择服务器外，还需要管理服务。如使用 supervisor, systemd 等方式
- 日志 为了快速定位 bug 以及溯源异常信息，你需要学会使用日志模块输出日志而不是简单地使用`print('errorInfo')`这种方式 debug, 常用的日志模块有`log4j`等
- 配置 如果开发环境和生产环境不一样，配置管理是必须的
- 测试 虽然不是必要的，但是能够增加项目的健壮性，但是不要为了测试而测试
- 版本控制 开发必备，不多说，使用`Git`吧，还建议使用贴近项目的工作流[Git 工作流程](http://www.ruanyifeng.com/blog/2015/12/git-workflow.html)

## 更大、更复杂

利用蓝图和flask强大的扩展能力，你能创建更大的项目

```
proj
  │-app/
    │-templates/
    │-static/
    │-main/
      │-__init__.py
      │-errors.py
      │-forms.py
      │-views.py
    │-auth/
      │-__init__.py
      │-forms.py
      │-views.py
    │-__init__.py
    │-email.py
    │-models.py
  │-migrations/
  │-tests/
    │-__init__.py
    │-test*.py
  │-venv/
  │-requirements.txt
  │-config.py
  │-manage.py
```

### 应用细节

- `manage.py`主入口

```python
#!/usr/bin/python
# -*- coding:utf-8 -*-
import os
from app import create_app

# 配置
config_name = os.getenv('FLASK_CONFIG') or 'default'
app = create_app(config_name)

# gunicorn -k gevent -w 8 -b 127.0.0.1:5000 manage:app
if __name__ == '__main__':
    app.run(host='127.0.0.1', port=5000, debug=True)
```

- `config.py`配置文件

```python
#!/usr/bin/python
# -*- coding:utf-8 -*-

class Config(object):
    DEBUG = False
    TESTING = False
    DATABASE_URI = 'sqlite://:memory:'

    @staticmethod
    def init_app(app):
        pass

class ProductionConfig(Config):
    DATABASE_URI = 'mysql://user@localhost/foo'

class DevelopmentConfig(Config):
    DEBUG = True

class TestingConfig(Config):
    TESTING = True

config={
    'dev':DevelopmentConfig,
    'test':TestingConfig,
    'prod':ProductionConfig,
    'default':DevelopmentConfig
    }
```

- `app/__init__.py`app工厂函数，根据不同环境配置初始化app

```python
#!/usr/bin/python
# -*- coding:utf-8 -*-
from flask import Flask
from config import config

def create_app(config_name):
    app=Flask(__name__)

    # 加载配置
    app.config.from_object(config[config_name])
    config[config_name].init_app(app)

    # 注册蓝图
    from .main import main as main_blueprint
    app.register_blueprint(main_blueprint)

    app.logger.debug('应用初始化完成') # DEBUG
    return app
```

- `app/main/__init__.py` 蓝图

```python
#!/usr/bin/python
# -*- coding:utf-8 -*-
from flask import Blueprint

main = Blueprint('main', __name__)
```

- `app/main/views.py` 蓝图的视图

```python
#!/usr/bin/python
# -*- coding:utf-8 -*-
from flask import current_app as app
from . import main

# 测试接口
@main.route('/')
def index():
    app.logger.debug('SUCCESS') # DEBUG
    return 'Hello'
```

## 其他

- 前后端分离
- 缓存
- 权限管理
- 访客分析
- 服务器监控
- 负载均衡
- CDN
- 分布式
- CICD
- Python venv 虚拟环境
- ……

## 最后

并不是你的项目使用的架构越高级越好，盲目使用高级架构很容易迷失在各种空文件夹当中。在搭建项目的时候根据自己项目期望的大小，选择合适的架构才是正道。

## 参考文献

- [Linux 技巧：让进程在后台可靠运行的几种方法](https://www.ibm.com/developerworks/cn/linux/l-cn-nohup/)
- [flask](http://flask.pocoo.org/)
- [Flask-Foundation](https://github.com/JackStouffer/Flask-Foundation)
- [Cookiecutter](https://github.com/audreyr/cookiecutter)
